<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="generator" content="rustdoc"><meta name="description" content="Provides runtime access to the JavaScript engine."><meta name="keywords" content="rust, rustlang, rust-lang, context"><title>neon::context - Rust</title><link rel="stylesheet" type="text/css" href="../../normalize.css"><link rel="stylesheet" type="text/css" href="../../rustdoc.css" id="mainThemeStyle"><link rel="stylesheet" type="text/css" href="../../light.css"  id="themeStyle"><link rel="stylesheet" type="text/css" href="../../dark.css" disabled ><link rel="stylesheet" type="text/css" href="../../ayu.css" disabled ><script id="default-settings"></script><script src="../../storage.js"></script><script src="../../crates.js"></script><noscript><link rel="stylesheet" href="../../noscript.css"></noscript><link rel="icon" type="image/svg+xml" href="../../favicon.svg">
<link rel="alternate icon" type="image/png" href="../../favicon-16x16.png">
<link rel="alternate icon" type="image/png" href="../../favicon-32x32.png"><style type="text/css">#crate-search{background-image:url("../../down-arrow.svg");}</style></head><body class="rustdoc mod"><!--[if lte IE 8]><div class="warning">This old browser is unsupported and will most likely display funky things.</div><![endif]--><nav class="sidebar"><div class="sidebar-menu" role="button">&#9776;</div><a href='../../neon/index.html'><div class='logo-container rust-logo'><img src='../../rust-logo.png' alt='logo'></div></a><p class="location">Module context</p><div class="sidebar-elems"><div class="block items"><ul><li><a href="#structs">Structs</a></li><li><a href="#enums">Enums</a></li><li><a href="#traits">Traits</a></li><li><a href="#types">Type Definitions</a></li></ul></div><p class="location"><a href="../index.html">neon</a></p><div id="sidebar-vars" data-name="context" data-ty="mod" data-relpath="../"></div><script defer src="../sidebar-items.js"></script></div></nav><div class="theme-picker"><button id="theme-picker" aria-label="Pick another theme!" aria-haspopup="menu"><img src="../../brush.svg" width="18" height="18" alt="Pick another theme!"></button><div id="theme-choices" role="menu"></div></div><script src="../../theme.js"></script><nav class="sub"><form class="search-form"><div class="search-container"><div><select id="crate-search"><option value="All crates">All crates</option></select><input class="search-input" name="search" disabled autocomplete="off" spellcheck="false" placeholder="Click or press ‘S’ to search, ‘?’ for more options…" type="search"></div><button type="button" class="help-button">?</button>
                <a id="settings-menu" href="../../settings.html"><img src="../../wheel.svg" width="18" height="18" alt="Change settings"></a></div></form></nav><section id="main" class="content"><h1 class="fqn"><span class="in-band">Module <a href="../index.html">neon</a>::<wbr><a class="mod" href="">context</a></span><span class="out-of-band"><span id="render-detail"><a id="toggle-all-docs" href="javascript:void(0)" title="collapse all docs">[<span class="inner">&#x2212;</span>]</a></span><a class="srclink" href="../../src/neon/context/mod.rs.html#1-835" title="goto source code">[src]</a></span></h1><div class="docblock"><p>Provides runtime access to the JavaScript engine.</p>
<p>An <em>execution context</em> represents the current state of a thread of execution in the
JavaScript engine. Internally, it tracks things like the set of pending function calls,
whether the engine is currently throwing an exception or not, and whether the engine is
in the process of shutting down. The context uses this internal state to manage what
operations are safely available and when.</p>
<p>The <a href="../../neon/context/trait.Context.html"><code>Context</code></a> trait provides an abstract interface to the JavaScript
execution context. All interaction with the JavaScript engine in Neon code is mediated
through instances of this trait.</p>
<p>One particularly useful context type is <a href="../../neon/context/struct.CallContext.html"><code>CallContext</code></a>, which is passed
to all Neon functions as their initial execution context (or <a href="../../neon/context/type.FunctionContext.html"><code>FunctionContext</code></a>,
a convenient shorthand for <code>CallContext&lt;JsObject&gt;</code>):</p>

<div class="example-wrap"><pre class="rust rust-example-rendered">
<span class="kw">fn</span> <span class="ident">hello</span>(<span class="kw-2">mut</span> <span class="ident">cx</span>: <span class="ident">FunctionContext</span>) <span class="op">-</span><span class="op">&gt;</span> <span class="ident">JsResult</span><span class="op">&lt;</span><span class="ident">JsString</span><span class="op">&gt;</span> {
    <span class="prelude-val">Ok</span>(<span class="ident">cx</span>.<span class="ident">string</span>(<span class="string">&quot;hello Neon&quot;</span>))
}</pre></div>
<p>Another important context type is <a href="../../neon/context/struct.ModuleContext.html"><code>ModuleContext</code></a>, which is provided
to a Neon module’s <a href="../../neon/attr.main.html"><code>main</code></a> function to enable sharing Neon functions back
with JavaScript:</p>

<div class="example-wrap"><pre class="rust rust-example-rendered">
<span class="attribute">#[<span class="ident">neon</span>::<span class="ident">main</span>]</span>
<span class="kw">fn</span> <span class="ident">main</span>(<span class="kw-2">mut</span> <span class="ident">cx</span>: <span class="ident">ModuleContext</span>) <span class="op">-</span><span class="op">&gt;</span> <span class="ident">NeonResult</span><span class="op">&lt;</span>()<span class="op">&gt;</span> {
    <span class="ident">cx</span>.<span class="ident">export_function</span>(<span class="string">&quot;hello&quot;</span>, <span class="ident">hello</span>)<span class="question-mark">?</span>;
    <span class="prelude-val">Ok</span>(())
}</pre></div>
<h2 id="memory-management" class="section-header"><a href="#memory-management">Memory Management</a></h2>
<p>Because contexts represent the engine at a point in time, they are associated with a
<a href="https://doc.rust-lang.org/book/ch10-00-generics.html"><em>lifetime</em></a>, which limits how long Rust code is allowed to access them. This
is also used to determine the lifetime of <a href="../../neon/handle/struct.Handle.html"><code>Handle</code></a>s, which
provide safe references to JavaScript memory managed by the engine’s garbage collector.</p>
<p>For example, we can
write a simple string scanner that counts whitespace in a JavaScript string and
returns a <a href="../../neon/types/struct.JsNumber.html"><code>JsNumber</code></a>:</p>

<div class="example-wrap"><pre class="rust rust-example-rendered">
<span class="kw">fn</span> <span class="ident">count_whitespace</span>(<span class="kw-2">mut</span> <span class="ident">cx</span>: <span class="ident">FunctionContext</span>) <span class="op">-</span><span class="op">&gt;</span> <span class="ident">JsResult</span><span class="op">&lt;</span><span class="ident">JsNumber</span><span class="op">&gt;</span> {
    <span class="kw">let</span> <span class="ident">s</span>: <span class="ident">Handle</span><span class="op">&lt;</span><span class="ident">JsString</span><span class="op">&gt;</span> <span class="op">=</span> <span class="ident">cx</span>.<span class="ident">argument</span>(<span class="number">0</span>)<span class="question-mark">?</span>;
    <span class="kw">let</span> <span class="ident">contents</span> <span class="op">=</span> <span class="ident">s</span>.<span class="ident">value</span>(<span class="kw-2">&amp;</span><span class="kw-2">mut</span> <span class="ident">cx</span>);
    <span class="kw">let</span> <span class="ident">count</span> <span class="op">=</span> <span class="ident">contents</span>
        .<span class="ident">chars</span>()                       <span class="comment">// iterate over the characters</span>
        .<span class="ident">filter</span>(<span class="op">|</span><span class="ident">c</span><span class="op">|</span> <span class="ident">c</span>.<span class="ident">is_whitespace</span>()) <span class="comment">// select the whitespace chars</span>
        .<span class="ident">count</span>();                      <span class="comment">// count the resulting chars</span>
    <span class="prelude-val">Ok</span>(<span class="ident">cx</span>.<span class="ident">number</span>(<span class="ident">count</span> <span class="kw">as</span> <span class="ident">f64</span>))
}</pre></div>
<p>In this example, <code>s</code> is assigned a handle to a string, which ensures that the string
is <em>kept alive</em> (i.e., prevented from having its storage reclaimed by the JavaScript
engine’s garbage collector) for the duration of the <code>count_whitespace</code> function. This
is how Neon takes advantage of Rust’s type system to allow your Rust code to safely
interact with JavaScript values.</p>
<h3 id="temporary-scopes" class="section-header"><a href="#temporary-scopes">Temporary Scopes</a></h3>
<p>Sometimes it can be useful to limit the scope of a handle’s lifetime, to allow the
engine to reclaim memory sooner. This can be important when, for example, an expensive inner loop generates
temporary JavaScript values that are only needed inside the loop. In these cases,
the <a href="../../neon/context/trait.Context.html#method.execute_scoped"><code>execute_scoped</code></a> and <a href="../../neon/context/trait.Context.html#method.compute_scoped"><code>compute_scoped</code></a>
methods allow you to create temporary contexts in order to allocate temporary
handles.</p>
<p>For example, to extract the elements of a JavaScript <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Guide/Iterators_and_Generators">iterator</a> from Rust,
a Neon function has to work with several temporary handles on each pass through
the loop:</p>

<div class="example-wrap"><pre class="rust rust-example-rendered">
    <span class="kw">let</span> <span class="ident">iterator</span> <span class="op">=</span> <span class="ident">cx</span>.<span class="ident">argument</span>::<span class="op">&lt;</span><span class="ident">JsObject</span><span class="op">&gt;</span>(<span class="number">0</span>)<span class="question-mark">?</span>;         <span class="comment">// iterator object</span>
    <span class="kw">let</span> <span class="ident">next</span> <span class="op">=</span> <span class="ident">iterator</span>.<span class="ident">get</span>(<span class="kw-2">&amp;</span><span class="kw-2">mut</span> <span class="ident">cx</span>, <span class="string">&quot;next&quot;</span>)<span class="question-mark">?</span>           <span class="comment">// iterator&#39;s `next` method</span>
        .<span class="ident">downcast_or_throw</span>::<span class="op">&lt;</span><span class="ident">JsFunction</span>, <span class="kw">_</span><span class="op">&gt;</span>(<span class="kw-2">&amp;</span><span class="kw-2">mut</span> <span class="ident">cx</span>)<span class="question-mark">?</span>;
    <span class="kw">let</span> <span class="kw-2">mut</span> <span class="ident">numbers</span> <span class="op">=</span> <span class="macro">vec</span><span class="macro">!</span>[];                           <span class="comment">// results vector</span>
    <span class="kw">let</span> <span class="kw-2">mut</span> <span class="ident">done</span> <span class="op">=</span> <span class="bool-val">false</span>;                               <span class="comment">// loop controller</span>

    <span class="kw">while</span> <span class="op">!</span><span class="ident">done</span> {
        <span class="ident">done</span> <span class="op">=</span> <span class="ident">cx</span>.<span class="ident">execute_scoped</span>(<span class="op">|</span><span class="kw-2">mut</span> <span class="ident">cx</span><span class="op">|</span> {                   <span class="comment">// temporary scope</span>
            <span class="kw">let</span> <span class="ident">args</span>: <span class="ident">Vec</span><span class="op">&lt;</span><span class="ident">Handle</span><span class="op">&lt;</span><span class="ident">JsValue</span><span class="op">&gt;</span><span class="op">&gt;</span> <span class="op">=</span> <span class="macro">vec</span><span class="macro">!</span>[];
            <span class="kw">let</span> <span class="ident">obj</span> <span class="op">=</span> <span class="ident">next</span>.<span class="ident">call</span>(<span class="kw-2">&amp;</span><span class="kw-2">mut</span> <span class="ident">cx</span>, <span class="ident">iterator</span>, <span class="ident">args</span>)<span class="question-mark">?</span>     <span class="comment">// temporary object</span>
                .<span class="ident">downcast_or_throw</span>::<span class="op">&lt;</span><span class="ident">JsObject</span>, <span class="kw">_</span><span class="op">&gt;</span>(<span class="kw-2">&amp;</span><span class="kw-2">mut</span> <span class="ident">cx</span>)<span class="question-mark">?</span>;
            <span class="kw">let</span> <span class="ident">number</span> <span class="op">=</span> <span class="ident">obj</span>.<span class="ident">get</span>(<span class="kw-2">&amp;</span><span class="kw-2">mut</span> <span class="ident">cx</span>, <span class="string">&quot;value&quot;</span>)<span class="question-mark">?</span>           <span class="comment">// temporary number</span>
                .<span class="ident">downcast_or_throw</span>::<span class="op">&lt;</span><span class="ident">JsNumber</span>, <span class="kw">_</span><span class="op">&gt;</span>(<span class="kw-2">&amp;</span><span class="kw-2">mut</span> <span class="ident">cx</span>)<span class="question-mark">?</span>
                .<span class="ident">value</span>(<span class="kw-2">&amp;</span><span class="kw-2">mut</span> <span class="ident">cx</span>);
            <span class="ident">numbers</span>.<span class="ident">push</span>(<span class="ident">number</span>);
            <span class="prelude-val">Ok</span>(<span class="ident">obj</span>.<span class="ident">get</span>(<span class="kw-2">&amp;</span><span class="kw-2">mut</span> <span class="ident">cx</span>, <span class="string">&quot;done&quot;</span>)<span class="question-mark">?</span>                      <span class="comment">// temporary boolean</span>
                .<span class="ident">downcast_or_throw</span>::<span class="op">&lt;</span><span class="ident">JsBoolean</span>, <span class="kw">_</span><span class="op">&gt;</span>(<span class="kw-2">&amp;</span><span class="kw-2">mut</span> <span class="ident">cx</span>)<span class="question-mark">?</span>
                .<span class="ident">value</span>(<span class="kw-2">&amp;</span><span class="kw-2">mut</span> <span class="ident">cx</span>))
        })<span class="question-mark">?</span>;
    }</pre></div>
<p>The temporary scope ensures that the temporary values are only kept alive
during a single pass through the loop, since the temporary context is
discarded (and all of its handles released) on the inside of the loop.</p>
<h2 id="throwing-exceptions" class="section-header"><a href="#throwing-exceptions">Throwing Exceptions</a></h2>
<p>When a Neon API causes a JavaScript exception to be thrown, it returns an
<a href="https://doc.rust-lang.org/nightly/core/result/enum.Result.html#variant.Err"><code>Err</code></a> result, indicating that the thread associated
with the context is now throwing. This allows Rust code to perform any
cleanup before returning, but with an important restriction:</p>
<blockquote>
<p><strong>While a JavaScript thread is throwing, its context cannot be used.</strong></p>
</blockquote>
<p>Unless otherwise documented, any Neon API that uses a context (as <code>self</code> or as
a parameter) immediately panics if called while the context’s thread is throwing.</p>
<p>Typically, Neon code can manage JavaScript exceptions correctly and conveniently
by using Rust’s <a href="https://doc.rust-lang.org/edition-guide/rust-2018/error-handling-and-panics/the-question-mark-operator-for-easier-error-handling.html">question mark (<code>?</code>)</a> operator. This ensures that
Rust code “short-circuits” when an exception is thrown and returns back to
JavaScript without calling any throwing APIs.</p>
<p>Alternatively, to invoke a Neon API and catch any JavaScript exceptions, use the
<a href="Context::try_catch"><code>Context::try_catch</code></a> method, which catches any thrown
exception and restores the context to non-throwing state.</p>
<h2 id="see-also" class="section-header"><a href="#see-also">See also</a></h2>
<ol>
<li>Ecma International. <a href="https://tc39.es/ecma262/#sec-execution-contexts">Execution contexts</a>, <em>ECMAScript Language Specification</em>.</li>
<li>Madhavan Nagarajan. <a href="https://medium.com/@itIsMadhavan/what-is-the-execution-context-stack-in-javascript-e169812e851a">What is the Execution Context and Stack in JavaScript?</a></li>
<li>Rupesh Mishra. <a href="https://medium.com/@happymishra66/execution-context-in-javascript-319dd72e8e2c">Execution context, Scope chain and JavaScript internals</a>.</li>
</ol>
</div><h2 id="structs" class="section-header"><a href="#structs">Structs</a></h2>
<table><tr class="module-item"><td><a class="struct" href="struct.CallContext.html" title="neon::context::CallContext struct">CallContext</a></td><td class="docblock-short"><p>An execution context of a function call.</p>
</td></tr><tr class="module-item"><td><a class="struct" href="struct.ComputeContext.html" title="neon::context::ComputeContext struct">ComputeContext</a></td><td class="docblock-short"><p>An execution context of a scope created by <a href="../../neon/context/trait.Context.html#method.compute_scoped"><code>Context::compute_scoped()</code></a>.</p>
</td></tr><tr class="module-item"><td><a class="struct" href="struct.ExecuteContext.html" title="neon::context::ExecuteContext struct">ExecuteContext</a></td><td class="docblock-short"><p>An execution context of a scope created by <a href="../../neon/context/trait.Context.html#method.execute_scoped"><code>Context::execute_scoped()</code></a>.</p>
</td></tr><tr class="module-item"><td><a class="struct" href="struct.Lock.html" title="neon::context::Lock struct">Lock</a></td><td class="docblock-short"><p>A temporary lock of an execution context.</p>
</td></tr><tr class="module-item"><td><a class="struct" href="struct.ModuleContext.html" title="neon::context::ModuleContext struct">ModuleContext</a></td><td class="docblock-short"><p>An execution context of module initialization.</p>
</td></tr><tr class="module-item"><td><a class="struct" href="struct.TaskContext.html" title="neon::context::TaskContext struct">TaskContext</a></td><td class="docblock-short"><p>An execution context of a task completion callback.</p>
</td></tr></table><h2 id="enums" class="section-header"><a href="#enums">Enums</a></h2>
<table><tr class="module-item"><td><a class="enum" href="enum.CallKind.html" title="neon::context::CallKind enum">CallKind</a></td><td class="docblock-short"><p>Indicates whether a function was called with <code>new</code>.</p>
</td></tr></table><h2 id="traits" class="section-header"><a href="#traits">Traits</a></h2>
<table><tr class="module-item"><td><a class="trait" href="trait.Context.html" title="neon::context::Context trait">Context</a></td><td class="docblock-short"><p>An <em>execution context</em>, which represents the current state of a thread of execution in the JavaScript engine.</p>
</td></tr></table><h2 id="types" class="section-header"><a href="#types">Type Definitions</a></h2>
<table><tr class="module-item"><td><a class="type" href="type.FunctionContext.html" title="neon::context::FunctionContext type">FunctionContext</a></td><td class="docblock-short"><p>A shorthand for a <a href="../../neon/context/struct.CallContext.html"><code>CallContext</code></a> with <code>this</code>-type <a href="../../neon/types/struct.JsObject.html"><code>JsObject</code></a>.</p>
</td></tr><tr class="module-item"><td><a class="type" href="type.MethodContext.html" title="neon::context::MethodContext type">MethodContext</a></td><td class="docblock-short"><p>An alias for <a href="../../neon/context/struct.CallContext.html"><code>CallContext</code></a>, useful for indicating that the function is a method of a class.</p>
</td></tr></table></section><section id="search" class="content hidden"></section><section class="footer"></section><div id="rustdoc-vars" data-root-path="../../" data-current-crate="neon" data-search-js="../../search-index.js"></div>
    <script src="../../main.js"></script></body></html>